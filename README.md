# Android Offline TTS Eval

Standalone Android app + harness for **offline TTS speed benchmarking** (physical devices only).

## Key Points
- **Tokens = words** (`[A-Za-z0-9']+`)
- Metrics per run: `tok/s` and `RTF` (speed only)
- Models are downloaded **on-demand** to app external files; optional cleanup supported
- Default ABI: `arm64-v8a` only (no emulator ABI)

## Project Layout
- Android app: `android-offline-tts-eval/VoicePingAndroidOfflineTtsEval/`
- Host scripts: `android-offline-tts-eval/scripts/`
- Pulled artifacts + reports: `android-offline-tts-eval/artifacts/`

## Build / Install (Physical Device)
```bash
cd android-offline-tts-eval/VoicePingAndroidOfflineTtsEval
./setup-deps.sh
./gradlew :app:installDebug
```

## Headless Benchmark (Instrumentation)
Runs the English prompt suite and writes `audio.wav` + `result.json` per prompt:
`/sdcard/Android/data/com.voiceping.ttseval/files/exports/tts_eval/<run_id>/<model_id>/<prompt_id>/`

```bash
# Default planned model set (system + sherpa models)
android-offline-tts-eval/scripts/run_device_benchmark.sh
```

Environment overrides:
- `MODEL_IDS` (comma-separated)
- `RUN_MODE` (`warm` or `cold`)
- `WARM_ITERATIONS` (1-10)
- `THREADS` (1-16)
- `SPEAKER_ID`, `SPEED`
- `DOWNLOAD_HF` (`true|false`)
- `DELETE_AFTER` (`true|false`)

Example:
```bash
RUN_MODE=warm WARM_ITERATIONS=3 THREADS=4 \
MODEL_IDS=android-system-tts,kokoro-en-v0_19 \
android-offline-tts-eval/scripts/run_device_benchmark.sh
```

## Pull Results + Generate Report
```bash
# Pull one run by id (recommended)
android-offline-tts-eval/scripts/pull_results.sh <run_id>

# Aggregate and generate table + bar charts
python3 android-offline-tts-eval/scripts/generate_tts_report.py --run_id <run_id>
```

Outputs:
- `android-offline-tts-eval/artifacts/report/tts_report.md`
- `android-offline-tts-eval/artifacts/report/tts_results.json`
- `android-offline-tts-eval/artifacts/report/android_tts_tok_per_sec.svg`
- `android-offline-tts-eval/artifacts/report/android_tts_rtf.svg`

## NVIDIA NeMo (Local Bundle Import)
NeMo weights are not redistributed. Export ONNX locally and push the bundle:
```bash
# host-side export (Python 3.12 recommended)
android-offline-tts-eval/scripts/nemo/create_venv.sh
source android-offline-tts-eval/scripts/nemo/.venv-nemo/bin/activate
python android-offline-tts-eval/scripts/nemo/export_fastpitch_onnx.py
python android-offline-tts-eval/scripts/nemo/export_hifigan_onnx.py

# push to device
android-offline-tts-eval/scripts/nemo/push_bundle_to_device.sh
```

## Latest Benchmark (Example)
Device: `SM-G973C` (sdk_int=31)  
Run: `benchmark_1771162232484_warm` (warm, `warm_iterations=1`, `threads=4`)

### Bar Charts
![Median tok/s (tokens = words)](docs/android_tts_tok_per_sec.svg)
![Median RTF (lower is faster)](docs/android_tts_rtf.svg)

### Table
Generated by: `python3 android-offline-tts-eval/scripts/generate_tts_report.py --run_id <run_id>`

| Model ID | Engine | Prompt set | Median load (ms) | Median synth (ms) | Median tok/s | Median RTF | Count | Status |
|---|---|---:|---:|---:|---:|---:|---:|---|
| `android-system-tts` | `android_system_tts` | en | 319 | 408 | 37.85 | 0.055 | 12 | PASS |
| `vits-piper-en-us-amy-low` | `sherpa_offline_tts` | en | 2474 | 58 | 301.89 | 0.095 | 12 | PASS |
| `vits-piper-en-us-ryan-low` | `sherpa_offline_tts` | en | 2486 | 40 | 475.00 | 0.144 | 12 | PASS |
| `matcha-en-us-ljspeech` | `sherpa_offline_tts` | en | 2867 | 101 | 163.85 | 0.171 | 12 | PASS |
| `kitten-nano-en-v0_2-fp16` | `sherpa_offline_tts` | en | 2111 | 3500 | 5.13 | 0.385 | 12 | PASS |
| `kokoro-int8-multi-lang-v1_1` | `sherpa_offline_tts` | en | 3858 | 811 | 16.13 | 1.355 | 12 | PASS |
| `kokoro-en-v0_19` | `sherpa_offline_tts` | en | 2289 | 1575 | 12.13 | 2.608 | 12 | PASS |
